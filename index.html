<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contabilidad Digital v3.0 - Dashboard Avanzado</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #3B82F6; color: white; }
        .chart-container { height: 400px; }
        .date-range-dropdown { display: none; position: absolute; z-index: 50; }
        .date-range-dropdown.active { display: block; }
        .sync-indicator { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 100;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .sync-success { background-color: #10B981; color: white; }
        .sync-error { background-color: #EF4444; color: white; }
        .sync-syncing { background-color: #F59E0B; color: white; }
        @media print {
            body { -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="sync-indicator" class="sync-indicator" style="display: none;">
        <i class="fas fa-sync-alt mr-2"></i>
        <span id="sync-text">Sincronizando...</span>
    </div>

    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-chart-line text-blue-600 mr-3"></i>
                        Sistema de Contabilidad Digital
                    </h1>
                    <p class="text-gray-600">Gestión completa para productos digitales - WhatsApp & Meta Ads</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-600">Datos en la nube <i class="fas fa-cloud text-blue-500"></i></p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex flex-wrap border-b">
                <button class="tab-button px-6 py-3 font-medium text-gray-600 hover:text-blue-600 active" onclick="showTab('dashboard')">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('productos')">
                    <i class="fas fa-box mr-2"></i>Productos
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('metodos-pago')">
                    <i class="fas fa-credit-card mr-2"></i>Métodos de Pago
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('ventas')">
                    <i class="fas fa-shopping-cart mr-2"></i>Ventas
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('gastos-meta')">
                    <i class="fas fa-ad mr-2"></i>Gastos Meta
                </button>
                <button class="tab-button px-6 py-3 font-medium text-gray-600 hover:text-blue-600" onclick="showTab('reportes')">
                    <i class="fas fa-file-alt mr-2"></i>Reportes
                </button>
            </div>

            <div id="dashboard" class="tab-content active p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Principal</h2>
                    
                    <div class="relative">
                        <button id="date-range-button" onclick="toggleDateRangeDropdown()" class="bg-white border border-gray-300 rounded-md px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 flex items-center">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span id="selected-range-text">Últimos 7 días</span>
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        
                        <div id="date-range-dropdown" class="date-range-dropdown absolute right-0 mt-2 w-64 bg-white border border-gray-300 rounded-md shadow-lg">
                            <div class="py-1">
                                <button onclick="selectDateRange('today')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Hoy</button>
                                <button onclick="selectDateRange('yesterday')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ayer</button>
                                <button onclick="selectDateRange('last7days')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 bg-blue-50">Últimos 7 días</button>
                                <button onclick="selectDateRange('thismonth')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Este mes</button>
                                <hr class="my-1">
                                <button onclick="selectDateRange('custom')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Personalizado</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="custom-date-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="bg-white rounded-lg p-6 w-96">
                            <h3 class="text-lg font-semibold mb-4">Seleccionar Rango Personalizado</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Inicio</label>
                                    <input type="date" id="custom-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Fin</label>
                                    <input type="date" id="custom-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="flex justify-end space-x-3">
                                    <button onclick="closeCustomDateModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                                    <button onclick="applyCustomDateRange()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 p-6 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold">Ingresos Totales</h3>
                                <p class="text-2xl font-bold" id="total-ingresos">$0</p>
                            </div>
                            <i class="fas fa-dollar-sign text-3xl opacity-80"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-red-400 to-red-600 p-6 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold">Gastos Totales</h3>
                                <p class="text-2xl font-bold" id="total-gastos">$0</p>
                            </div>
                            <i class="fas fa-credit-card text-3xl opacity-80"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 p-6 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold">Ganancia Neta</h3>
                                <p class="text-2xl font-bold" id="ganancia-neta">$0</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl opacity-80"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 p-6 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold">ROI</h3>
                                <p class="text-2xl font-bold" id="roi-percentage">0%</p>
                            </div>
                            <i class="fas fa-percentage text-3xl opacity-80"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Ventas vs Gastos</h3>
                        <div class="chart-container">
                            <canvas id="chartVentasGastos"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Productos Más Vendidos</h3>
                        <div class="chart-container">
                            <canvas id="chartProductos"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="productos" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Gestión de Productos</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">Agregar/Editar Producto</h3>
                        <form id="producto-form">
                            <input type="hidden" id="producto-id">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label>
                                <input type="text" id="producto-nombre" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Precio (COP)</label>
                                <input type="number" id="producto-precio" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-save mr-2"></i>Guardar</button>
                                <button type="button" onclick="cancelarEdicionProducto()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600"><i class="fas fa-times mr-2"></i>Cancelar</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold mb-4">Productos Registrados</h3>
                            <div id="productos-lista" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="metodos-pago" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Métodos de Pago</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">Agregar/Editar Método de Pago</h3>
                        <form id="metodo-pago-form">
                            <input type="hidden" id="metodo-id">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Método</label>
                                <input type="text" id="metodo-nombre" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-save mr-2"></i>Guardar</button>
                                <button type="button" onclick="cancelarEdicionMetodo()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600"><i class="fas fa-times mr-2"></i>Cancelar</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold mb-4">Métodos Registrados</h3>
                            <div id="metodos-lista" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ventas" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Registro de Ventas</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">Nueva Venta</h3>
                        <form id="venta-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                                <select id="venta-producto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Precio (COP)</label>
                                <input type="number" id="venta-precio" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pago</label>
                                <select id="venta-metodo-pago" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                                <input type="date" id="venta-fecha" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notas (opcional)</label>
                                <textarea id="venta-notas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700"><i class="fas fa-plus mr-2"></i>Registrar Venta</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Resumen del Día</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between"><span>Ventas Hoy:</span><span id="ventas-hoy" class="font-semibold">0</span></div>
                            <div class="flex justify-between"><span>Ingresos Hoy:</span><span id="ingresos-hoy" class="font-semibold">$0</span></div>
                            <div class="flex justify-between"><span>Ventas Esta Semana:</span><span id="ventas-semana" class="font-semibold">0</span></div>
                            <div class="flex justify-between"><span>Ingresos Esta Semana:</span><span id="ingresos-semana" class="font-semibold">$0</span></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">Historial de Ventas</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Método Pago</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="ventas-tabla" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gastos-meta" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Gastos Meta Ads</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">Registrar Gasto Meta</h3>
                        <form id="gasto-meta-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Campaña</label>
                                <input type="text" id="gasto-campana" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Inicio</label>
                                <input type="date" id="gasto-fecha-inicio" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Fin</label>
                                <input type="date" id="gasto-fecha-fin" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Monto Total (COP)</label>
                                <input type="number" id="gasto-monto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700"><i class="fas fa-plus mr-2"></i>Registrar Gasto</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Resumen de Gastos</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between"><span>Gasto Hoy:</span><span id="gasto-hoy" class="font-semibold text-red-600">$0</span></div>
                            <div class="flex justify-between"><span>Gasto Esta Semana:</span><span id="gasto-semana" class="font-semibold text-red-600">$0</span></div>
                            <div class="flex justify-between"><span>Gasto Este Mes:</span><span id="gasto-mes" class="font-semibold text-red-600">$0</span></div>
                            <div class="flex justify-between"><span>Total de Gastos:</span><span id="gasto-total" class="font-semibold text-red-600">$0</span></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">Historial de Gastos Meta</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Campaña</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Inicio</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Fin</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="gastos-tabla" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportes" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Reportes y Análisis</h2>
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h3 class="text-lg font-semibold mb-4">Filtros de Reporte</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Inicio</label>
                            <input type="date" id="reporte-fecha-inicio" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Fin</label>
                            <input type="date" id="reporte-fecha-fin" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div class="flex items-end">
                            <button onclick="generarReporte()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                <i class="fas fa-chart-bar mr-2"></i>Generar Reporte
                            </button>
                        </div>
                    </div>
                </div>
                <div id="reporte-detallado" class="mt-6">
                    <p class="text-gray-500">Selecciona un rango de fechas y genera el reporte para ver los detalles.</p>
                </div>
            </div>
        </div>
    </div>

<script>
    // URL base de la API (Vercel la manejará automáticamente)
    const API_URL = '/api';

    // Variables globales para almacenar los datos de la BD
    let productos = [];
    let metodosPago = [];
    let ventas = [];
    let gastosMeta = [];

    let charts = {};
    let currentDateRange = 'last7days';
    let currentDateRangeData = {};

    // --- NUEVO: Funciones de API ---

    // Función genérica para hacer peticiones a la API
    async function fetchAPI(endpoint, options = {}) {
        const indicator = document.getElementById('sync-indicator');
        const text = document.getElementById('sync-text');
        
        indicator.className = 'sync-indicator sync-syncing';
        text.textContent = 'Sincronizando...';
        indicator.style.display = 'block';

        try {
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error en la petición a ${endpoint}`);
            }
            
            indicator.className = 'sync-indicator sync-success';
            text.textContent = 'Sincronizado';
            
            if (response.status === 204) { // No Content
                return null;
            }
            return response.json();
        } catch (error) {
            console.error(`Error en API: ${error.message}`);
            indicator.className = 'sync-indicator sync-error';
            text.textContent = 'Error de conexión';
            alert(`Error de comunicación con el servidor: ${error.message}`);
            throw error;
        } finally {
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
    }

    // Función para cargar todos los datos iniciales desde la API
    async function cargarDatosDesdeAPI() {
        try {
            // Usamos Promise.all para hacer las peticiones en paralelo
            const [productosData, metodosPagoData, ventasData, gastosData] = await Promise.all([
                fetchAPI('/productos'),
                fetchAPI('/metodos-pago'),
                fetchAPI('/ventas'),
                fetchAPI('/gastos')
            ]);
            
            productos = productosData;
            metodosPago = metodosPagoData;
            ventas = ventasData;
            gastosMeta = gastosData;
            
            // Una vez cargados los datos, actualizamos toda la UI
            inicializarAplicacion();
        } catch (error) {
            alert('No se pudieron cargar los datos iniciales. Revisa la consola para más detalles.');
        }
    }

    // --- FUNCIONES CORREGIDAS ---
    
    function calcularGastoPorFecha(fecha) {
        let gasto = 0;
        const fechaObj = new Date(fecha + 'T00:00:00');
        
        gastosMeta.forEach(gastoMeta => {
            const inicio = new Date(gastoMeta.fecha_inicio + 'T00:00:00');
            const fin = new Date(gastoMeta.fecha_fin + 'T00:00:00');
            
            // Verificar si la fecha está dentro del rango de la campaña
            if (fechaObj >= inicio && fechaObj <= fin) {
                // Calcular la proporción diaria
                const diasTotales = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
                gasto += parseFloat(gastoMeta.monto) / diasTotales;
            }
        });
        
        return gasto;
    }

    function actualizarDashboard() {
        const ventasFiltradas = filtrarVentasPorRango();
        const totalIngresos = ventasFiltradas.reduce((sum, v) => sum + parseFloat(v.precio), 0);
        
        // Calcular gastos solo para el rango seleccionado
        let totalGastos = 0;
        if (currentDateRangeData.startDate && currentDateRangeData.endDate) {
            const inicio = new Date(currentDateRangeData.startDate + 'T00:00:00');
            const fin = new Date(currentDateRangeData.endDate + 'T00:00:00');
            
            for (let fecha = new Date(inicio); fecha <= fin; fecha.setDate(fecha.getDate() + 1)) {
                totalGastos += calcularGastoPorFecha(fecha.toISOString().split('T')[0]);
            }
        }
        
        const gananciaNeta = totalIngresos - totalGastos;
        const roi = totalGastos > 0 ? ((gananciaNeta / totalGastos) * 100) : (totalIngresos > 0 ? Infinity : 0);

        document.getElementById('total-ingresos').textContent = formatearPesos(totalIngresos);
        document.getElementById('total-gastos').textContent = formatearPesos(totalGastos);
        document.getElementById('ganancia-neta').textContent = formatearPesos(gananciaNeta);
        document.getElementById('roi-percentage').textContent = roi === Infinity ? '∞%' : `${roi.toFixed(1)}%`;
        
        actualizarGraficos();
    }

    // --- Funciones de la Aplicación ---

    function formatearPesos(cantidad) {
        return '$' + (Number(cantidad) || 0).toLocaleString('es-CO');
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.closest('.tab-button').classList.add('active');
        
        if (tabName === 'dashboard') {
            actualizarDashboard();
        }
    }

    // Gestión de Productos
    function cargarProductos() {
        const lista = document.getElementById('productos-lista');
        lista.innerHTML = '';
        productos.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(producto => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg';
            div.innerHTML = `
                <div>
                    <h4 class="font-semibold">${producto.nombre}</h4>
                    <p class="text-gray-600">${formatearPesos(producto.precio)}</p>
                </div>
                <div class="space-x-2">
                    <button onclick="editarProducto(${producto.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                    <button onclick="eliminarProducto(${producto.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </div>
            `;
            lista.appendChild(div);
        });
        cargarSelectProductos();
    }

    document.getElementById('producto-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = document.getElementById('producto-id').value;
        const productoData = {
            nombre: document.getElementById('producto-nombre').value,
            precio: parseFloat(document.getElementById('producto-precio').value)
        };

        try {
            if (id) {
                const actualizado = await fetchAPI(`/productos`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: parseInt(id), ...productoData })
                });
                const index = productos.findIndex(p => p.id == id);
                productos[index] = actualizado;
            } else {
                const nuevo = await fetchAPI('/productos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(productoData)
                });
                productos.push(nuevo);
            }
            cargarProductos();
            cancelarEdicionProducto();
        } catch(error) {}
    });

    function editarProducto(id) {
        const producto = productos.find(p => p.id === id);
        document.getElementById('producto-id').value = producto.id;
        document.getElementById('producto-nombre').value = producto.nombre;
        document.getElementById('producto-precio').value = parseFloat(producto.precio);
    }

    function cancelarEdicionProducto() {
        document.getElementById('producto-form').reset();
        document.getElementById('producto-id').value = '';
    }

    async function eliminarProducto(id) {
        if (confirm('¿Estás seguro de eliminar este producto? Podría afectar registros de ventas existentes.')) {
            try {
                await fetchAPI(`/productos`, {
                    method: 'DELETE',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ id })
                });
                productos = productos.filter(p => p.id !== id);
                cargarProductos();
                actualizarDashboard();
            } catch (error) {}
        }
    }

    // Gestión de Métodos de Pago
    function cargarMetodosPago() {
        const lista = document.getElementById('metodos-lista');
        lista.innerHTML = '';
        metodosPago.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(metodo => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg';
            div.innerHTML = `
                <div><h4 class="font-semibold">${metodo.nombre}</h4></div>
                <div class="space-x-2">
                    <button onclick="editarMetodo(${metodo.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                    <button onclick="eliminarMetodo(${metodo.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </div>
            `;
            lista.appendChild(div);
        });
        cargarSelectMetodosPago();
    }

    document.getElementById('metodo-pago-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = document.getElementById('metodo-id').value;
        const metodoData = { nombre: document.getElementById('metodo-nombre').value };
        try {
            if (id) {
                const actualizado = await fetchAPI(`/metodos-pago`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: parseInt(id), ...metodoData })
                });
                const index = metodosPago.findIndex(m => m.id == id);
                metodosPago[index] = actualizado;
            } else {
                const nuevo = await fetchAPI('/metodos-pago', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(metodoData)
                });
                metodosPago.push(nuevo);
            }
            cargarMetodosPago();
            cancelarEdicionMetodo();
        } catch (error) {}
    });

    function editarMetodo(id) {
        const metodo = metodosPago.find(m => m.id === id);
        document.getElementById('metodo-id').value = metodo.id;
        document.getElementById('metodo-nombre').value = metodo.nombre;
    }

    function cancelarEdicionMetodo() {
        document.getElementById('metodo-pago-form').reset();
        document.getElementById('metodo-id').value = '';
    }

    async function eliminarMetodo(id) {
        if (confirm('¿Estás seguro de eliminar este método de pago?')) {
            try {
                await fetchAPI(`/metodos-pago`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                metodosPago = metodosPago.filter(m => m.id !== id);
                cargarMetodosPago();
            } catch (error) {}
        }
    }

    // Gestión de Ventas
    function cargarVentas() {
        const tabla = document.getElementById('ventas-tabla');
        tabla.innerHTML = '';
        ventas.forEach(venta => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${venta.fecha}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${venta.producto_nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatearPesos(venta.precio)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${venta.metodo_pago_nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <button onclick="eliminarVenta(${venta.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tabla.appendChild(tr);
        });
    }

    document.getElementById('venta-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const ventaData = {
            producto_id: parseInt(document.getElementById('venta-producto').value),
            metodo_pago_id: parseInt(document.getElementById('venta-metodo-pago').value),
            precio: parseFloat(document.getElementById('venta-precio').value),
            fecha: document.getElementById('venta-fecha').value,
            notas: document.getElementById('venta-notas').value
        };
        try {
            const result = await fetchAPI('/ventas', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(ventaData)
            });
            const producto = productos.find(p => p.id === result.producto_id);
            const metodo = metodosPago.find(m => m.id === result.metodo_pago_id);
            const nuevaVentaConNombres = { ...result, producto_nombre: producto.nombre, metodo_pago_nombre: metodo.nombre };
            
            ventas.unshift(nuevaVentaConNombres);
            
            cargarVentas();
            actualizarResumenVentas();
            actualizarDashboard();
            document.getElementById('venta-form').reset();
            document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0];
        } catch(error) {}
    });

    async function eliminarVenta(id) {
        if (confirm('¿Estás seguro de eliminar esta venta?')) {
            try {
                await fetchAPI('/ventas', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                ventas = ventas.filter(v => v.id !== id);
                cargarVentas();
                actualizarResumenVentas();
                actualizarDashboard();
            } catch (error) {}
        }
    }

    // Gestión de Gastos
    function cargarGastosMeta() {
        const tabla = document.getElementById('gastos-tabla');
        tabla.innerHTML = '';
        gastosMeta.forEach(gasto => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${gasto.campana}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${gasto.fecha_inicio}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${gasto.fecha_fin}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatearPesos(gasto.monto)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <button onclick="eliminarGasto(${gasto.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tabla.appendChild(tr);
        });
    }

    document.getElementById('gasto-meta-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const gastoData = {
            campana: document.getElementById('gasto-campana').value,
            fecha_inicio: document.getElementById('gasto-fecha-inicio').value,
            fecha_fin: document.getElementById('gasto-fecha-fin').value,
            monto: parseFloat(document.getElementById('gasto-monto').value)
        };
        try {
            const nuevoGasto = await fetchAPI('/gastos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(gastoData)
            });
            gastosMeta.unshift(nuevoGasto);
            cargarGastosMeta();
            actualizarResumenGastos();
            actualizarDashboard();
            document.getElementById('gasto-meta-form').reset();
        } catch (error) {}
    });

    async function eliminarGasto(id) {
        if (confirm('¿Estás seguro de eliminar este gasto?')) {
            try {
                await fetchAPI('/gastos', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                gastosMeta = gastosMeta.filter(g => g.id !== id);
                cargarGastosMeta();
                actualizarResumenGastos();
                actualizarDashboard();
            } catch (error) {}
        }
    }

    function cargarSelectProductos() {
        const select = document.getElementById('venta-producto');
        select.innerHTML = '<option value="">Seleccionar producto</option>';
        productos.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.nombre} - ${formatearPesos(p.precio)}`;
            option.dataset.precio = p.precio;
            select.appendChild(option);
        });
    }

    function cargarSelectMetodosPago() {
        const select = document.getElementById('venta-metodo-pago');
        select.innerHTML = '<option value="">Seleccionar método</option>';
        metodosPago.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.nombre;
            select.appendChild(option);
        });
    }

    document.getElementById('venta-producto').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.precio) {
            document.getElementById('venta-precio').value = parseFloat(selectedOption.dataset.precio);
        }
    });

    function inicializarAplicacion() {
        document.getElementById('venta-fecha').value = new Date().toISOString().split('T')[0];
        document.getElementById('gasto-fecha-inicio').value = new Date().toISOString().split('T')[0];
        document.getElementById('gasto-fecha-fin').value = new Date().toISOString().split('T')[0];
        cargarProductos();
        cargarMetodosPago();
        cargarVentas();
        cargarGastosMeta();
        actualizarResumenVentas();
        actualizarResumenGastos();
        updateDateRangeData('last7days');
        actualizarDashboard();
    }

    // --- Dashboard, Resúmenes y Gráficos ---
    function actualizarResumenVentas() {
        const hoy = new Date().toISOString().split('T')[0];
        const inicioSemana = new Date();
        inicioSemana.setDate(inicioSemana.getDate() - (inicioSemana.getDay() === 0 ? 6 : inicioSemana.getDay() - 1));
        const inicioSemanaStr = inicioSemana.toISOString().split('T')[0];
        
        const ventasHoy = ventas.filter(v => v.fecha === hoy);
        const ventasSemana = ventas.filter(v => v.fecha >= inicioSemanaStr);
        
        document.getElementById('ventas-hoy').textContent = ventasHoy.length;
        document.getElementById('ingresos-hoy').textContent = formatearPesos(ventasHoy.reduce((sum, v) => sum + parseFloat(v.precio), 0));
        document.getElementById('ventas-semana').textContent = ventasSemana.length;
        document.getElementById('ingresos-semana').textContent = formatearPesos(ventasSemana.reduce((sum, v) => sum + parseFloat(v.precio), 0));
    }

    function actualizarResumenGastos() {
        const hoyStr = new Date().toISOString().split('T')[0];
        const hoy = new Date(hoyStr + 'T00:00:00');
        const semanaInicio = new Date(hoy);
        semanaInicio.setDate(hoy.getDate() - (hoy.getDay() === 0 ? 6 : hoy.getDay() - 1));
        const mesInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        
        let gastoSemana = 0;
        for (let fecha = new Date(semanaInicio); fecha <= hoy; fecha.setDate(fecha.getDate() + 1)) {
            gastoSemana += calcularGastoPorFecha(fecha.toISOString().split('T')[0]);
        }
        
        let gastoMes = 0;
        for (let fecha = new Date(mesInicio); fecha <= hoy; fecha.setDate(fecha.getDate() + 1)) {
            gastoMes += calcularGastoPorFecha(fecha.toISOString().split('T')[0]);
        }
        
        document.getElementById('gasto-hoy').textContent = formatearPesos(calcularGastoPorFecha(hoyStr));
        document.getElementById('gasto-semana').textContent = formatearPesos(gastoSemana);
        document.getElementById('gasto-mes').textContent = formatearPesos(gastoMes);
        document.getElementById('gasto-total').textContent = formatearPesos(gastosMeta.reduce((sum, g) => sum + parseFloat(g.monto), 0));
    }
    
    function actualizarGraficos() {
        const ventasFiltradas = filtrarVentasPorRango();
        const fechas = [];
        const ventasData = [];
        const gastosData = [];
        
        if (currentDateRangeData.startDate && currentDateRangeData.endDate) {
            const inicio = new Date(currentDateRangeData.startDate + 'T00:00:00');
            const fin = new Date(currentDateRangeData.endDate + 'T00:00:00');
            
            for (let fecha = new Date(inicio); fecha <= fin; fecha.setDate(fecha.getDate() + 1)) {
                const fechaStr = fecha.toISOString().split('T')[0];
                fechas.push(fecha.toLocaleDateString('es-CO', { day: 'numeric', month: 'short' }));
                ventasData.push(ventasFiltradas.filter(v => v.fecha === fechaStr).reduce((sum, v) => sum + parseFloat(v.precio), 0));
                gastosData.push(calcularGastoPorFecha(fechaStr));
            }
        }
        
        if (charts.ventasGastos) charts.ventasGastos.destroy();
        charts.ventasGastos = new Chart(document.getElementById('chartVentasGastos').getContext('2d'), { type: 'line', data: { labels: fechas, datasets: [{ label: 'Ventas', data: ventasData, borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.1)', tension: 0.1 }, { label: 'Gastos', data: gastosData, borderColor: 'rgb(239, 68, 68)', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => formatearPesos(value) } } }, plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatearPesos(context.parsed.y)}` } } } });
        
        const productosVendidos = ventasFiltradas.reduce((acc, venta) => {
            acc[venta.producto_nombre] = (acc[venta.producto_nombre] || 0) + 1;
            return acc;
        }, {});
        const productosOrdenados = Object.entries(productosVendidos).sort(([,a], [,b]) => b - a).slice(0, 5);
        
        if (charts.productos) charts.productos.destroy();
        if (productosOrdenados.length > 0) {
            charts.productos = new Chart(document.getElementById('chartProductos').getContext('2d'), { type: 'doughnut', data: { labels: productosOrdenados.map(([nombre]) => nombre), datasets: [{ data: productosOrdenados.map(([, cant]) => cant), backgroundColor: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        } else {
            document.getElementById('chartProductos').getContext('2d').clearRect(0, 0, 400, 400);
        }
    }
    
    function generarReporte() {
        const fechaInicio = document.getElementById('reporte-fecha-inicio').value;
        const fechaFin = document.getElementById('reporte-fecha-fin').value;
        if (!fechaInicio || !fechaFin || fechaInicio > fechaFin) {
            alert('Por favor selecciona un rango de fechas válido.');
            return;
        }

        const ventasReporte = ventas.filter(v => v.fecha >= fechaInicio && v.fecha <= fechaFin);
        let gastosReporte = 0;
        const rangoInicio = new Date(fechaInicio + 'T00:00:00');
        const rangoFin = new Date(fechaFin + 'T00:00:00');

        for (let fecha = new Date(rangoInicio); fecha <= rangoFin; fecha.setDate(fecha.getDate() + 1)) {
            gastosReporte += calcularGastoPorFecha(fecha.toISOString().split('T')[0]);
        }

        const ingresosReporte = ventasReporte.reduce((sum, v) => sum + parseFloat(v.precio), 0);
        const ganancia = ingresosReporte - gastosReporte;
        const roi = gastosReporte > 0 ? (ganancia / gastosReporte * 100) : (ingresosReporte > 0 ? Infinity : 0);

        const reporteDiv = document.getElementById('reporte-detallado');
        reporteDiv.innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-green-100 p-4 rounded-lg"><h4 class="font-semibold text-green-800">Ingresos</h4><p class="text-2xl font-bold text-green-600">${formatearPesos(ingresosReporte)}</p></div>
                <div class="bg-red-100 p-4 rounded-lg"><h4 class="font-semibold text-red-800">Gastos</h4><p class="text-2xl font-bold text-red-600">${formatearPesos(gastosReporte)}</p></div>
                <div class="bg-blue-100 p-4 rounded-lg"><h4 class="font-semibold text-blue-800">Ganancia</h4><p class="text-2xl font-bold text-blue-600">${formatearPesos(ganancia)}</p></div>
                <div class="bg-purple-100 p-4 rounded-lg"><h4 class="font-semibold text-purple-800">ROI</h4><p class="text-2xl font-bold text-purple-600">${roi === Infinity ? '∞%' : `${roi.toFixed(1)}%`}</p></div>
            </div>`;
    }

    // Funciones de Rango de Fechas
    function toggleDateRangeDropdown() { document.getElementById('date-range-dropdown').classList.toggle('active'); }
    function closeCustomDateModal() { document.getElementById('custom-date-modal').classList.add('hidden'); }

    function selectDateRange(range) {
        currentDateRange = range;
        if (range === 'custom') {
            document.getElementById('custom-date-modal').classList.remove('hidden');
        } else {
            updateDateRangeData(range);
            actualizarDashboard();
        }
        toggleDateRangeDropdown();
    }

    function applyCustomDateRange() {
        const startDate = document.getElementById('custom-start-date').value;
        const endDate = document.getElementById('custom-end-date').value;
        if (!startDate || !endDate || startDate > endDate) { alert('Selecciona un rango de fechas válido.'); return; }
        currentDateRangeData = { startDate, endDate, label: `${startDate.split('-')[2]}/${startDate.split('-')[1]} - ${endDate.split('-')[2]}/${endDate.split('-')[1]}` };
        document.getElementById('selected-range-text').textContent = currentDateRangeData.label;
        closeCustomDateModal();
        actualizarDashboard();
    }

    function updateDateRangeData(range) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let startDate, endDate = new Date(today), label;

        switch(range) {
            case 'today': startDate = new Date(today); label = 'Hoy'; break;
            case 'yesterday': startDate = new Date(today); startDate.setDate(today.getDate() - 1); endDate = new Date(startDate); label = 'Ayer'; break;
            case 'last7days': startDate = new Date(today); startDate.setDate(today.getDate() - 6); label = 'Últimos 7 días'; break;
            case 'thismonth': startDate = new Date(today.getFullYear(), today.getMonth(), 1); label = 'Este mes'; break;
            default: startDate = new Date(today); startDate.setDate(today.getDate() - 6); label = 'Últimos 7 días'; break;
        }
        currentDateRangeData = { startDate: startDate.toISOString().split('T')[0], endDate: endDate.toISOString().split('T')[0], label };
        document.getElementById('selected-range-text').textContent = label;
    }

    function filtrarVentasPorRango() {
        if (!currentDateRangeData.startDate) return ventas;
        return ventas.filter(v => v.fecha >= currentDateRangeData.startDate && v.fecha <= currentDateRangeData.endDate);
    }
    
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('date-range-dropdown');
        const button = document.getElementById('date-range-button');
        if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
            dropdown.classList.remove('active');
        }
    });

    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', cargarDatosDesdeAPI);
</script>

</body>
</html>
